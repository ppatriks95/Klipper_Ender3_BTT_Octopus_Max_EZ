# This file contains common pin mappings for the BIGTREETECH Octopus Max EZ.
# To use this config, the firmware should be compiled for the
# STM32H723 with a "128KiB bootloader" "25 MHz crystal"
# and "USB (on PA11/PA12)" or "CAN bus (on PD0/PD1)".

# See docs/Config_Reference.md for a description of parameters.
[include mainsail.cfg]

# Motor-1 -> X
[stepper_x]
step_pin: PC13
dir_pin: PC14
enable_pin: !PE6  # Attention: ! inverts Signal, neccessary for TMC2209
microsteps: 16
rotation_distance: 40
endstop_pin: ^PF0
position_endstop: 0
position_max: 235
homing_speed: 20

# Motor-3 -> Z
[stepper_z]
step_pin: PE1
dir_pin: !PE0
enable_pin: !PE2
microsteps: 16
rotation_distance: 8
#endstop_pin: ^PF2  dont use pin when you have a Probe, otherwise the extruder gets against the bed
endstop_pin: probe:z_virtual_endstop
#position_endstop: 0
position_min: -5      
position_max: 235
homing_speed: 5               
second_homing_speed: 2        
homing_retract_dist: 3

# Motor-2 -> Y
[stepper_y]
step_pin: PE4
dir_pin: PE5
enable_pin: !PE3
microsteps: 16
rotation_distance: 40               
endstop_pin: ^PF4
position_endstop: 0
position_min: -10         
position_max: 250
homing_speed: 30

# Motor-4 -> Extruder (E)
[extruder]
step_pin: PB8
dir_pin: PB9
enable_pin:!PB7
microsteps: 16
rotation_distance: 7.37
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PF6 #Red thick cables which come from the Extruder part for Energy (Heating Cartridge), goes to the clamp under Power In, Bed In etc. HE01
sensor_pin: PB0 # white cable Extruder TH0 = PB0
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 21.73
#pid_Ki: 1.18
#pid_Kd: 108.08
min_temp: 0
max_temp: 250

[verify_heater extruder]
max_error: 120
check_gain_time: 60
hysteresis: 10
heating_gain: 5

[safe_z_home]
home_xy_position: 70,117     
speed: 30               
z_hop: 10
z_hop_speed: 5

[beam_camera] 

# Motor-5 isnt used in this config as extruder
#[extruder]
#step_pin: PB5
#dir_pin: PB4
#enable_pin: !PB6
#microsteps: 16
#rotation_distance: 33.500
#nozzle_diameter: 0.400
#filament_diameter: 1.750
#heater_pin: PF6 # HE0
#sensor_pin:  PB0 # T0
#sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
#min_temp: 0
#max_temp: 250

#[filament_switch_sensor material_0]
#switch_pin: PF1

# Motor-6
#[extruder1]
#step_pin: PG15
#dir_pin: PB3
#enable_pin: !PD5
#heater_pin: PA0 # HE1
#sensor_pin: PC5 # T1
#...

#[filament_switch_sensor material_1]
#switch_pin: PC15

# Motor-7
#[extruder2]
#step_pin: PD3
#dir_pin: PD2
#enable_pin: !PD4
#heater_pin: PF9 # HE2
#sensor_pin: PC4 # T2
#...

# Motor-8
#[extruder3]
#step_pin: PA10
#dir_pin: PA9
#enable_pin: !PA15
#heater_pin: PF7 # HE3
#sensor_pin: PA7 # T3
#...

# Motor-9
#[extruder4]
#step_pin: PA8
#dir_pin: PC7
#enable_pin: !PC9
#...

# Motor-10
#[extruder5]
#step_pin: PG6
#dir_pin: PC6
#enable_pin: !PC8
#...

[heater_bed]
heater_pin: PF5
sensor_pin: PB1 # TB
sensor_type: EPCOS 100K B57560G104F
min_temp: 0
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
max_temp: 120

[bed_mesh]
speed: 120
horizontal_move_z: 5
mesh_min: 30, 25        # First Measure point
mesh_max: 188, 220      # Last  Measure point
probe_count: 7, 7
algorithm: bicubic
bicubic_tension: 0.2


######################################################################
# Biqu Micro Probe V2 Configuration ( Specifically used for given Probe. No guarantee for Bltouch !)
######################################################################

[output_pin probe_enable]
pin: PB14
value: 0

[gcode_macro PROBE_DOWN]
gcode:
    SET_PIN PIN=probe_enable VALUE=1
    G4 P500

[gcode_macro PROBE_UP]
gcode:
    SET_PIN PIN=probe_enable VALUE=0
    G4 P500

[probe]
pin: ^!PB15       
deactivate_on_each_sample: False
x_offset: -47
y_offset: -5
z_offset: 0
speed: 3.0
samples: 2
sample_retract_dist: 2.0
samples_tolerance: 0.05
samples_tolerance_retries: 3

activate_gcode:
   PROBE_DOWN #Official documentation of Microprobe
    G4 P500

deactivate_gcode:
    PROBE_UP  #Official documentation of Microprobe

######################################################################
# Fan Section
######################################################################

# Side Cooler (right side cooler at Extruder, blue-yellow cables on FAN0)
[fan]
pin: PA6
kick_start_time: 0.5         
off_below: 0.1               

# Hotend-Cooler (front Cooler, black-red on FAN1) 
[heater_fan hotend_fan]
pin: PA5
max_power: 1.0
kick_start_time: 0.5
heater: extruder              # runs when extruder is hot
heater_temp: 50.0              # activate at 50Â°C
fan_speed: 1.0                 # Always 100% on
shutdown_speed: 0.0

#[heater_fan fan1]
#pin: PA5

#[heater_fan fan2]
#pin: PA4

#[heater_fan fan3]
#pin: PA3

#[heater_fan fan4]
#pin: PA1
#tachometer_pin: PC3

#[heater_fan fan5]
#pin: PF8
#tachometer_pin: PC1

#[heater_fan fan6]
#pin: PA2
#tachometer_pin: PC2

[gcode_macro HOTEND_FAN_ON]
description: Changes Hotend-Fan to 100%
gcode:
    SET_PIN PIN=PA5 VALUE=1
    RESPOND MSG="Hotend-Fan 100%"

[gcode_macro HOTEND_FAN_OFF]
description: Deactivate Hotend-Fan 
gcode:
    SET_PIN PIN=PA5 VALUE=0
    RESPOND MSG="Hotend-Fan OFF"

[gcode_macro HOTEND_FAN_50]
description: Changes Hotend-Fan to 50%
gcode:
    SET_PIN PIN=PA5 VALUE=0.5
    RESPOND MSG="Hotend-Fan 50%"

[gcode_macro HOTEND_FAN]
description: Change Hotend-Fan speed (i.e. HOTEND_FAN SPEED=70 for 70%)
gcode:
    {% set speed = params.SPEED|default(0)|int %}
    {% if speed < 0 or speed > 100 %}
        { action_respond_info("Illegal Speed! Use 0-100") }
    {% else %}
        {% set pwm = (speed / 100.0) %}
        SET_PIN PIN=PA5 VALUE={pwm}
        RESPOND MSG="Hotend-Fan {speed}%"
    {% endif %}


#####################################################################
# Webcam Section
#####################################################################

[gcode_macro FOCUS_3]
description: Change Focus auf 3 (the best)
gcode:
    SET_CAMERA_FOCUS AUTOFOCUS=false FOCUS_DISTANCE=3.0

[gcode_macro FOCUS_TEST]
description: Checks different Focus-Distances
gcode:
    # Deactivate autofocus
    SET_CAMERA_FOCUS AUTOFOCUS=false FOCUS_DISTANCE=0.5
    G4 P2000  # wait 2 Seconds
    SET_CAMERA_FOCUS AUTOFOCUS=false FOCUS_DISTANCE=1.0
    G4 P2000
    SET_CAMERA_FOCUS AUTOFOCUS=false FOCUS_DISTANCE=2.0
    G4 P2000
    SET_CAMERA_FOCUS AUTOFOCUS=false FOCUS_DISTANCE=3.0
    G4 P2000
    SET_CAMERA_FOCUS AUTOFOCUS=false FOCUS_DISTANCE=5.0
    G4 P2000
    SET_CAMERA_FOCUS AUTOFOCUS=true  # Back to autofocus

[gcode_macro FLASHLIGHT_ON]
description: Schaltet die Kamera-LED ein
gcode:
    SET_CAMERA_FLASHLIGHT ENABLED=true
    RESPOND MSG="Kamera-LED EIN"

[gcode_macro FLASHLIGHT_OFF]
description: Schaltet die Kamera-LED aus
gcode:
    SET_CAMERA_FLASHLIGHT ENABLED=false
    RESPOND MSG="Kamera-LED AUS"
###################################################################
# other makros
###################################################################
####################
## Makros leveling
######################
[gcode_macro CORNER1]
description: Geht zu Ecke 1 (Vorne Links) - OHNE erneutes Homen
gcode:
    G90
    G1 Z10 F3000              # DÃ¼se anheben
    G1 X10 Y10 F6000          # Zur ersten Ecke
    G1 Z0.2 F600              # Auf vernÃ¼nftige TesthÃ¶he (nicht 0.1!)
    RESPOND MSG="ðŸ“ ECKE 1 - Jetzt Schraube einstellen!"

[gcode_macro CORNER2]
description: Geht zu Ecke 2 (Vorne Rechts)
gcode:
    G90
    G1 Z10 F3000
    G1 X200 Y10 F6000         # X anpassen!
    G1 Z0.2 F600
    RESPOND MSG="ðŸ“ ECKE 2 - Schraube einstellen!"

[gcode_macro CORNER3]
description: Geht zu Ecke 3 (Hinten Rechts)
gcode:
    G90
    G1 Z10 F3000
    G1 X200 Y200 F6000        # X,Y anpassen!
    G1 Z0.2 F600
    RESPOND MSG="ðŸ“ ECKE 3 - Schraube einstellen!"

[gcode_macro CORNER4]
description: Geht zu Ecke 4 (Hinten Links)
gcode:
    G90
    G1 Z10 F3000
    G1 X10 Y200 F6000
    G1 Z0.2 F600
    RESPOND MSG="ðŸ“ ECKE 4 - Schraube einstellen!"

[gcode_macro LEVEL_START]
description: Startet den Level-Vorgang (einmal homen)
gcode:
    G28
    G1 Z10 F3000
    RESPOND MSG="âœ… Bereit zum Leveln! Nutze CORNER1-4"

[gcode_macro HOME_AND_LIFT]
description: Hebt die DÃ¼se an
gcode:
    G90
    G28
    G1 Z10 F3000
    RESPOND MSG="DÃ¼se angehoben - bereit!"

###################################################################
# Other
###################################################################
[mcu] # mit einzelnden otg adapter
serial: /data/user/0/ru.ytkab0bp.beamklipper/files/serial/1d50_614e
restart_method: command

#[mcu]
#serial: 
#  - /data/user/0/ru.ytkab0bp.beamklipper/files/serial/1d50_614e
#  - /dev/bus/usb/001/005
#  - /dev/bus/usb/001/002
#  - /dev/bus/usb/001/004
#restart_method: command

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

[screws_tilt_adjust]
screw1: 30.5, 37
screw1_name: Vorne links
screw2: 30.5, 207
screw2_name: Hinten links
screw3: 204.5, 207
screw3_name: Hinten rechts
screw4: 204.5, 37
screw4_name: Vorne rechts
horizontal_move_z: 10
speed: 100
screw_thread: CW-M3

########################################
# TMC2209 configuration
########################################
#Motor-1 -> X
[tmc2209 stepper_x]
uart_pin: PG14
interpolate: True
run_current: 0.800
hold_current: 0.5
stealthchop_threshold: 999999

# Motor-2 -> Y
[tmc2209 stepper_y]
uart_pin: PG13
interpolate: True
run_current: 0.800
hold_current: 0.5
stealthchop_threshold: 999999

# Motor-3 -> Z
[tmc2209 stepper_z]
uart_pin: PG12
interpolate: True
run_current: 0.650
hold_current: 0.5
stealthchop_threshold: 999999

#[tmc2209 stepper_]
#uart_pin: PG11
##diag_pin: PF3
#run_current: 0.650
#stealthchop_threshold: 999999

[tmc2209 extruder]
uart_pin: PG11
run_current: 0.800
hold_current: 0.5
stealthchop_threshold: 999999

#[tmc2209 extruder1]
#uart_pin: PG9
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder2]
#uart_pin: PD7
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder3]
#uart_pin: PD6
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder4]
#uart_pin: PG8
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2209 extruder5]
#uart_pin: PG7
#run_current: 0.800
#stealthchop_threshold: 999999

########################################
# TMC2130 configuration
########################################

#[tmc2130 stepper_x]
#cs_pin: PG14
#spi_bus: spi4
##diag1_pin: PF0
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 stepper_y]
#cs_pin: PG13
#spi_bus: spi4
##diag1_pin: PF2
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 stepper_z]
#cs_pin: PG12
#spi_bus: spi4
##diag1_pin: PF4
#run_current: 0.650
#stealthchop_threshold: 999999

#[tmc2130 stepper_]
#cs_pin: PG11
#spi_bus: spi4
##diag1_pin: PF3
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder]
#cs_pin: PG10
#spi_bus: spi4
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder1]
#cs_pin: PG9
#spi_bus: spi4
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder2]
#cs_pin: PD7
#spi_bus: spi4
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder3]
#cs_pin: PD6
#spi_bus: spi4
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder4]
#cs_pin: PG8
#spi_bus: spi4
#run_current: 0.800
#stealthchop_threshold: 999999

#[tmc2130 extruder5]
#cs_pin: PG7
#spi_bus: spi4
#run_current: 0.800
#stealthchop_threshold: 999999

[board_pins]
aliases:
    # FPC header, Aliases EXP1 & EXP2 for mini12864
    EXP1_1=PG2, EXP1_2=PD15,
    EXP1_3=PD14, EXP1_4=PD13,
    EXP1_5=PD12, EXP1_6=PD11,
    EXP1_7=PD10, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PE13, EXP2_2=PE12,
    EXP2_3=PG5, EXP2_4=PE11,
    EXP2_5=PG4, EXP2_6=PE14,
    EXP2_7=PG3, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<NC>

# See the sample-lcd.cfg file for definitions of common LCD displays.

#[bltouch]
#sensor_pin: ^PB15
#control_pin: PB14

# Proximity switch
#[probe]
#pin: PF11

#[output_pin ps_on_pin]
#pin: PF13

#[output_pin pf12_pin]
#pin: PF12

#[neopixel my_neopixel_1]
#pin: PE10

#[neopixel my_neopixel_2]
#pin: PE9

#[hall_filament_width_sensor]
#adc1: PC0
#adc2: PF10

#[adxl345]
#cs_pin: PF14
#spi_bus: spi4
[virtual_sdcard]
path: /data/user/0/ru.ytkab0bp.beamklipper/files/instance/85f945e1-c71d-4d58-b9e4-20695939a747/public/gcodes

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 30.042
#*# pid_ki = 2.154
#*# pid_kd = 104.772
